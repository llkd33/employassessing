const { Pool } = require('pg');
require('dotenv').config();

// PostgreSQL Ïó∞Í≤∞ ÌíÄ ÏÑ§Ï†ï
console.log('üîç NODE_ENV:', process.env.NODE_ENV);
console.log('üîç DATABASE_URL ÏÑ§Ï†ï Ïó¨Î∂Ä:', process.env.DATABASE_URL ? '‚úÖ ÏÑ§Ï†ïÎê®' : '‚ùå ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏùå');
if (process.env.DATABASE_URL) {
    console.log('üîç DATABASE_URL ÌîÑÎ°úÌÜ†ÏΩú:', process.env.DATABASE_URL.split('://')[0]);
}

// Railway PostgreSQL IPv6 Î¨∏Ï†ú Ìï¥Í≤∞
let poolConfig = {
    connectionString: process.env.DATABASE_URL,
    ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false
};

// Railway ÌôòÍ≤ΩÏóêÏÑú IPv6 Î¨∏Ï†ú Ìï¥Í≤∞
if (process.env.DATABASE_URL && process.env.NODE_ENV === 'production') {
    try {
        const url = new URL(process.env.DATABASE_URL);
        // IPv6 Ï£ºÏÜåÏù∏ Í≤ΩÏö∞ IPv4Î°ú Î≥ÄÍ≤Ω ÏãúÎèÑ
        if (url.hostname.includes(':')) {
            console.log('‚ö†Ô∏è IPv6 Ï£ºÏÜå Í∞êÏßÄ, Ïó∞Í≤∞ ÏÑ§Ï†ï Ï°∞Ï†ï Ï§ë...');
            poolConfig = {
                ...poolConfig,
                host: url.hostname,
                port: url.port || 5432,
                database: url.pathname.slice(1),
                user: url.username,
                password: url.password,
                ssl: { rejectUnauthorized: false },
                // IPv4 Í∞ïÏ†ú
                connectionTimeoutMillis: 10000,
                query_timeout: 10000,
                statement_timeout: 10000
            };
        }
    } catch (err) {
        console.error('DATABASE_URL ÌååÏã± Ïò§Î•ò:', err);
    }
}

const pool = new Pool(poolConfig);

// Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
pool.on('connect', () => {
    console.log('‚úÖ PostgreSQL Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Ïóê Ïó∞Í≤∞ÎêòÏóàÏäµÎãàÎã§.');
});

pool.on('error', (err) => {
    console.error('‚ùå Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞ Ïò§Î•ò:', err);
});

// Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ìï®ÏàòÎì§
const db = {
    // ÏÇ¨Ïö©Ïûê Í¥ÄÎ†® Ìï®ÏàòÎì§
    async createUser(userData) {
        const { user_id, name, email, password, login_type } = userData;
        const query = `
            INSERT INTO users (user_id, name, email, password, login_type)
            VALUES ($1, $2, $3, $4, $5)
            RETURNING *
        `;
        try {
            const result = await pool.query(query, [user_id, name, email, password, login_type]);
            return result.rows[0];
        } catch (error) {
            console.error('ÏÇ¨Ïö©Ïûê ÏÉùÏÑ± Ïò§Î•ò:', error);
            throw error;
        }
    },

    async getUserByEmail(email) {
        const query = 'SELECT * FROM users WHERE email = $1';
        try {
            const result = await pool.query(query, [email]);
            return result.rows[0];
        } catch (error) {
            console.error('Ïù¥Î©îÏùºÎ°ú ÏÇ¨Ïö©Ïûê Ï°∞Ìöå Ïò§Î•ò:', error);
            throw error;
        }
    },

    async getUserByUserId(user_id) {
        const query = 'SELECT * FROM users WHERE user_id = $1';
        try {
            const result = await pool.query(query, [user_id]);
            return result.rows[0];
        } catch (error) {
            console.error('ÏÇ¨Ïö©Ïûê IDÎ°ú Ï°∞Ìöå Ïò§Î•ò:', error);
            throw error;
        }
    },

    // JWT ÌÜ†ÌÅ∞ Í≤ÄÏ¶ùÏö© getUserById Ìï®Ïàò (getUserByUserIdÏôÄ ÎèôÏùº)
    async getUserById(user_id) {
        const query = 'SELECT * FROM users WHERE user_id = $1';
        try {
            const result = await pool.query(query, [user_id]);
            return result.rows[0];
        } catch (error) {
            console.error('JWT ÌÜ†ÌÅ∞ Í≤ÄÏ¶ùÏö© ÏÇ¨Ïö©Ïûê ID Ï°∞Ìöå Ïò§Î•ò:', error);
            throw error;
        }
    },

    async getAllUsers() {
        const query = 'SELECT * FROM users ORDER BY created_at DESC';
        try {
            const result = await pool.query(query);
            return result.rows;
        } catch (error) {
            console.error('Î™®Îì† ÏÇ¨Ïö©Ïûê Ï°∞Ìöå Ïò§Î•ò:', error);
            throw error;
        }
    },

    async deleteUser(user_id) {
        const client = await pool.connect();
        try {
            await client.query('BEGIN');

            // Î®ºÏ†Ä ÌÖåÏä§Ìä∏ ÎãµÎ≥ÄÎì§ ÏÇ≠Ï†ú
            await client.query(`
                DELETE FROM test_answers 
                WHERE result_id IN (
                    SELECT result_id FROM test_results WHERE user_id = $1
                )
            `, [user_id]);

            // ÌÖåÏä§Ìä∏ Í≤∞Í≥ºÎì§ ÏÇ≠Ï†ú
            await client.query('DELETE FROM test_results WHERE user_id = $1', [user_id]);

            // ÏÇ¨Ïö©Ïûê ÏÇ≠Ï†ú
            const result = await client.query('DELETE FROM users WHERE user_id = $1 RETURNING *', [user_id]);

            await client.query('COMMIT');
            return result.rows[0];
        } catch (error) {
            await client.query('ROLLBACK');
            console.error('ÏÇ¨Ïö©Ïûê ÏÇ≠Ï†ú Ïò§Î•ò:', error);
            throw error;
        } finally {
            client.release();
        }
    },

    // ÌÖåÏä§Ìä∏ Í≤∞Í≥º Í¥ÄÎ†® Ìï®ÏàòÎì§
    async createTestResult(testData) {
        const {
            result_id, session_id, user_id, overall_score,
            problem_solving_score, communication_score, leadership_score,
            creativity_score, teamwork_score, test_date, submitted_at, answers
        } = testData;

        const client = await pool.connect();
        try {
            await client.query('BEGIN');

            // ÌÖåÏä§Ìä∏ Í≤∞Í≥º Ï†ÄÏû•
            const resultQuery = `
                INSERT INTO test_results (
                    result_id, session_id, user_id, overall_score,
                    problem_solving_score, communication_score, leadership_score,
                    creativity_score, teamwork_score, test_date, submitted_at
                )
                VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11)
                RETURNING *
            `;

            const testResult = await client.query(resultQuery, [
                result_id, session_id, user_id, overall_score,
                problem_solving_score, communication_score, leadership_score,
                creativity_score, teamwork_score, test_date, submitted_at
            ]);

            // ÎãµÎ≥ÄÎì§ Ï†ÄÏû•
            for (const answer of answers) {
                await client.query(
                    'INSERT INTO test_answers (result_id, question_id, answer) VALUES ($1, $2, $3)',
                    [result_id, answer.id, answer.answer]
                );
            }

            await client.query('COMMIT');
            return testResult.rows[0];
        } catch (error) {
            await client.query('ROLLBACK');
            console.error('ÌÖåÏä§Ìä∏ Í≤∞Í≥º Ï†ÄÏû• Ïò§Î•ò:', error);
            throw error;
        } finally {
            client.release();
        }
    },

    async getTestResultBySessionId(session_id) {
        const query = `
            SELECT tr.*, ta.question_id, ta.answer
            FROM test_results tr
            LEFT JOIN test_answers ta ON tr.result_id = ta.result_id
            WHERE tr.session_id = $1
            ORDER BY ta.question_id
        `;
        try {
            const result = await pool.query(query, [session_id]);
            if (result.rows.length === 0) return null;

            // Í≤∞Í≥º Íµ¨Ï°∞Ìôî
            const testResult = {
                id: result.rows[0].result_id,
                sessionId: result.rows[0].session_id,
                userId: result.rows[0].user_id,
                overallScore: result.rows[0].overall_score,
                competencyScores: {
                    problemSolving: result.rows[0].problem_solving_score,
                    communication: result.rows[0].communication_score,
                    leadership: result.rows[0].leadership_score,
                    creativity: result.rows[0].creativity_score,
                    teamwork: result.rows[0].teamwork_score
                },
                testDate: result.rows[0].test_date,
                submittedAt: result.rows[0].submitted_at,
                answers: {}
            };

            // ÎãµÎ≥ÄÎì§ Ï∂îÍ∞Ä
            result.rows.forEach(row => {
                if (row.question_id) {
                    testResult.answers[row.question_id] = row.answer;
                }
            });

            return testResult;
        } catch (error) {
            console.error('ÏÑ∏ÏÖò IDÎ°ú ÌÖåÏä§Ìä∏ Í≤∞Í≥º Ï°∞Ìöå Ïò§Î•ò:', error);
            throw error;
        }
    },

    async getUserTestResults(user_id, limit = 20) {
        const query = `
            SELECT result_id, session_id, overall_score,
                   problem_solving_score, communication_score, leadership_score,
                   creativity_score, teamwork_score, test_date, submitted_at
            FROM test_results 
            WHERE user_id = $1 
            ORDER BY test_date DESC 
            LIMIT $2
        `;
        try {
            const result = await pool.query(query, [user_id, limit]);
            return result.rows.map(row => ({
                id: row.result_id,
                sessionId: row.session_id,
                overallScore: row.overall_score,
                competencyScores: {
                    problemSolving: row.problem_solving_score,
                    communication: row.communication_score,
                    leadership: row.leadership_score,
                    creativity: row.creativity_score,
                    teamwork: row.teamwork_score
                },
                testDate: row.test_date,
                submittedAt: row.submitted_at
            }));
        } catch (error) {
            console.error('ÏÇ¨Ïö©Ïûê ÌÖåÏä§Ìä∏ Í≤∞Í≥º Ï°∞Ìöå Ïò§Î•ò:', error);
            throw error;
        }
    },

    async getAllTestResults(limit = 100) {
        const query = `
            SELECT result_id, session_id, user_id, overall_score,
                   problem_solving_score, communication_score, leadership_score,
                   creativity_score, teamwork_score, test_date, submitted_at
            FROM test_results 
            ORDER BY test_date DESC 
            LIMIT $1
        `;
        try {
            const result = await pool.query(query, [limit]);
            return result.rows;
        } catch (error) {
            console.error('Î™®Îì† ÌÖåÏä§Ìä∏ Í≤∞Í≥º Ï°∞Ìöå Ïò§Î•ò:', error);
            throw error;
        }
    },

    // ÌÜµÍ≥Ñ Í¥ÄÎ†® Ìï®ÏàòÎì§
    async getTestStats() {
        try {
            const totalTests = await pool.query('SELECT COUNT(*) as count FROM test_results');
            const totalUsers = await pool.query('SELECT COUNT(*) as count FROM users');
            const avgScore = await pool.query('SELECT AVG(overall_score) as avg FROM test_results');

            return {
                totalTests: parseInt(totalTests.rows[0].count),
                totalUsers: parseInt(totalUsers.rows[0].count),
                averageScore: Math.round(parseFloat(avgScore.rows[0].avg) || 0)
            };
        } catch (error) {
            console.error('ÌÜµÍ≥Ñ Ï°∞Ìöå Ïò§Î•ò:', error);
            throw error;
        }
    },

    // Ïó∞Í≤∞ Ï¢ÖÎ£å
    async close() {
        await pool.end();
        console.log('Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞Ïù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.');
    }
};

module.exports = db; 